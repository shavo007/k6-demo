on: [push]

jobs:
  k6_transpile_bundle_test:
    name: Transpile, bundle and run
    runs-on: ubuntu-latest
    # runs-on: self-hosted
    services:
      greetings:
        image: shanelee007/greetings-api:latest
        ports:
          - 8090:8081

    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Cache node modules
        uses: c-hive/gha-yarn-cache@v1
        # uses: actions/cache@v2
        # env:
        #   cache-name: cache-node-modules
        # with:
        #   path: ~/.npm
        #   key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/yarn.lock') }}
        #   restore-keys: |
        #     ${{ runner.os }}-build-${{ env.cache-name }}-
      - name: Install dependencies
        run: |
          yarn

      - name: Transpile and bundle test script
        run: |
          yarn webpack

      - name: Run local k6 test
        uses: k6io/action@v0.2.0
        with:
          filename: dist/test1.js

      - name: Run greetings api smoke tests
        run: |
          sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6
          docker ps
          k6 run - <dist/greetings.js
        # uses: k6io/action@v0.2.0
        # with:
        #   filename: dist/greetings.js
